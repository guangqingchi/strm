---
title: "An Introduction to strm"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to strm}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 5, fig.width = 8, message = TRUE, warning = FALSE)
library(rmarkdown)
#load strm
library(strm)

#load package dependencies for the vignette
library(tidyr)
library(dplyr)
library(rgdal)
library(spatialreg)
library(spdep)
library(sf)
library(splm)
library(knitr)
library(Ecdat)
```

`strm` is an `R` package that fits spatio-temporal regression model based on Chi & Zhu *Spatial Regression Models for the Social Sciences* (2019). Based on Elhorst 2001, 2003, and 2010a, the approach here fits a spatial error model while incorporating a temporally lagged response variable, temporally lagged explanatory variables, and spatially lagged explanatory variables.

This package builds on the `errorsarlm()` function from the `spatialreg` package.

This package is still under development. Please report bugs or constructive tips to issues [here](https://github.com/mkamenet3/strm/issues).


#Introduction


Fit a spatial error model but include a temporally lagged response variable, temporally lagged explanatory variable, and temporally and spatially lagged explanatory variables.

Spatial error model at time $t$:

$$Y_t = X_t \beta + u_t, u_t=\rho Wu_t + \varepsilon$$

Adding in a temporally lagged response variable and temporally lagged explanatory variable:

$$Y_t = X_t\beta_t + \beta_2Y_{t-1} + X_{t-1}\beta_3 + u_t, u_t=\rho Wu_t + \varepsilon$$


This becomes:

$$Y_t = Y_{t-1} \beta_2 + \rho W Y_t - \rho\beta_2 WY_{t-1} + X_t \beta_1 + X_{t-1}\beta_3 - W X_t \rho \beta_1 -WX_{t-1} \rho \beta_3 + \varepsilon$$


##Example 1: Produce in the United States

(This example has been adapted from the `splm` package vignette.)


The first data set we will use is the **Produc** data set from the `Ecdat` package. This data set is a panel of United States production data from 1970-1986. There are 816 observations by county in the United States. The variables we will use are:

- `year`: year
- `state`: state in the United States
- `gsp`:
- `pcap`: private capital stock.
- `pc`: public captial.
- `emp`: labor input measured by employment in non-agricultural payrolls.
- `unemp`: state unemployment rate.

We also load **usaww** from the `splm` package, a spatial weights matrix of the 48 contintental United States based on second-order neighbors.


```{r}
#load data example
data("Produc")
data("usaww")

#explore the data structures
str(Produc)
str(usaww)

```

###Single Year Lag

We next convert the spatial weights matrix to a list of spatial weights using the `mat2listw()` function from the `spdep` package and check the `class()` of the object:

```{r}
#create list of spatial weights
usalw <- mat2listw(usaww)
class(usalw)
```

Next, we perform the spatio-temporal regression model. We first create a formula using `as.formula()`. For this model, our response is `log(gsp)` and our explanatory variables are `log(pcap), log(pc), log(emp), unemp`.

For this analysis, we will limit the data to only 1970 and 1971 - two time periods.

We se the `strm()` function from the `strm` package. The first argument is the model formula. Given that the data is in *long* format, `strm` will create the lagged values for you as well as the lagged response in the right-hand side of the model. The next argument is `id`, which we set to "state" as each observation is taken at the state level. We then specify the name of the data set (`data=Produc`), the list of spatial weights (`listw = usalw`), `time=2`, we tell `strm` that the data is in *long* format by setting `wide=FALSE`, and lastly we pass an argument to filter observations where `year` is equal to either 1970 or 1971 (2 time periods).



```{r}
formula1 <-as.formula(log(gsp)  ~ log(pcap) + log(pc) + log(emp) + unemp)
out <- strm(formula1, id="state", data=Produc, listw = usalw, time=2,wide=FALSE,year==1970 | year==1971)
summary(out)

```

From the model summary output, we see that `strm` has included lagged variables (\*.Tlag1) for each of the explanatory variables initially specified (`log(pcap), log(pc), log(emp), unemp`), as well as a lagged variable for the response (`log(gsp)`).


###With 2 Lags

As the number of time periods in the data increase, so do the number of lags. If we now use the same model, but instead include an additional year (1972) and set `time=3`.

```{r}
formula2 <-as.formula(log(gsp)  ~ log(pcap) + log(pc) + log(emp) + unemp)
out <- strm(formula2, id="state", data=Produc, listw= usalw, time=3,
            wide=FALSE,year==1970 | year==1971 | year ==1972)

```


After executing the `strm()` model, we apply the `summary()` function to the results object, `out`.

```{r}
summary(out)

```

From the model summary output, we see that `strm` has now included two lagged variables (\*.Tlag1 and \*.Tlag2) for each of the explanatory variables initially specified, as well as two lags for the response variable.

##Example 2: Minor Civil Divisions in Wisconsin

**TODO: Introduce example**

There are two years of data: 2000 and 2010.

```{r}
sptdmg <- readOGR("../inst/extdata/sptdmg3/.", "sptdmg3")
class(sptdmg)
names(sptdmg)
```


First, fit a standard linear regression model with population growth from 2000 to 2010 as the response variable and population growth from 1990 to 2000, the old population in 2000, and the old population in 1990 as the explanatory variables.

```{r}
formula2 <- as.formula(LNP1000 ~ LNP0090 + POLD00 + POLD90)
m2 <- lm(formula2, data = sptdmg)
summary(m2)

```



Create spatial weights matrix based on 4-nearest neighbors:



```{r}
#convert to simple features
sptdmg_sf <- sf::st_as_sf(sptdmg)
class(sptdmg_sf)

#attempt with sf
nb.poly <- poly2nb(sptdmg, row.names=row.names(sptdmg))
listw <- nb2listw(nb.poly, style="W", zero.policy = TRUE)
coords <-st_coordinates(st_centroid(sptdmg_sf)) #extract centroid of each  minor civil division
plot(sptdmg, main="Wisconsin: Second-Order Neighbors");
plot(nb.poly, coords, col="blue", add=TRUE)

#knn4
col.knn <- knearneigh(coords, k=4)
nbknn <- knn2nb(col.knn)
listwk <- nb2listw(nbknn, style="W", zero.policy = TRUE)
plot(sptdmg, main="Wisconsin: 4 Nearest-Neighbors"); plot(nbknn, coords,col="forestgreen", add=TRUE)
```


Perform spatio-temporal regression model:

```{r}
id <- "STFID"
#since this data is in wide format, include temporal lag for both explanatory and response variable manually
res <- strm(formula2, id="STFID", data=sptdmg_sf, listw = listwk, time=2,wide=TRUE)
summary(res)
```




