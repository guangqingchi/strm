---
title: "Using strm with tidycensus"
output: rmarkdown::html_vignette
header-includes:
   - \usepackage{float}
vignette: >
  %\VignetteIndexEntry{Intro to strm}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 5, fig.width = 8, message = TRUE, warning = FALSE)
library(rmarkdown)
#load strm
library(strm)
#load tidycensus
library(tidycensus)
options(tigris_use_cache = TRUE)
#load package dependencies for the vignette
library(tidyr)
library(dplyr)
library(ggplot2)
library(patchwork)
library(purrr)
library(rgdal)
library(spdep)

```


`strm` is an `R` package that fits spatio-temporal regression model based on Chi & Zhu *Spatial Regression Models for the Social Sciences* (2019). The approach here fits a spatial error model while incorporating a temporally lagged response variable and temporally lagged explanatory variables.

This package builds on the `errorsarlm()` function from the `spatialreg` package.

This package is still under development. Please report bugs or constructive tips to issues [here](https://github.com/mkamenet3/strm/issues).

#Introduction


This data example will work through downloading census data using the `tidycensus` package, creating spatial weights, and then using `strm` to fit the spatio-temporal regression model.

##Downloading Census Data Using `tidycensus`

From the `tidycensus` package, we use the `census_api_key()` function and specify `install=TRUE` so that the API key is stored in the local R environment. To access the variables we want from the American Community Survey. It should be noted that using tidycensus, we can also access the 1990, 2000, and 2010 decennial US Census data as well.

```{r, echo=FALSE, eval=FALSE, results=FALSE}
census_api_key("1142ff2af9614e5b2a4bccdab5a432f8adc910ea", install=TRUE, overwrite = TRUE)
```

```{r,eval=FALSE}
census_api_key("YOUR API KEY HERE", install=TRUE)
```

(You may need to either restart your R session or run `readRenviron("~/.Renviron")` in your console to use the API key immediately.)

```{r, eval=FALSE}
vars <- load_variables(2018, "acs5", cache=TRUE)
```


```{r}
head(vars)
```

B17020_002 - Estimate!!Total!!Income in the past 12 months below poverty level

B01003_001 - total population estimate

B23022_026 Estimate!!Total!!FemaleSex by Work STatus in the past 12 months by usual hours worked per week in the past 12 months by weeks worked in the past 12 months for the population 16-64 years old


B23022_001 - Estimate!!Total: Sex by Work Status in the past 12 months by usual hours worked per week in the past 12 months by weeks worked in the past 12 months for the population 16-64 years old


To get 5-year estimates from 2010-2014, 2011-2015, 2012-2016, 2013-2017, 2014-2018:

```{r, results=FALSE}
years <- lst(2014,2015,2016,2017,2018)


multi_year <- map(years,~ get_acs(geography = "county",
                                  variables = c("B17020_001","B17020_002","B23022_026","B23022_001"),
                                  state = "WI",
                                  year = .x,
                                  geometry = TRUE)) %>%
              map2(years, ~ mutate(.x, id = .y))

wi_raw <- reduce(multi_year, rbind)

```

```{r}
class(wi_raw)
str(wi_raw)
head(wi_raw)
```

## Long-Form Data
###Exploratory (Spatial) Data Analysis

Calculate percent of population that is at or below poverty level by county:

```{r}
wi <- wi_raw %>%
    dplyr::select(-moe) %>%
    spread(key = variable, value=estimate) %>%
    mutate(pov_prct = B17020_002/B17020_001,
           feemp_prct = B23022_026/B23022_001,
           year=id,
           logpov = log(pov_prct),
           logfeemp = log(pov_prct)) 

```


```{r}
summary(wi$pov_prct)
tapply(wi$pov_prct, wi$year, summary)
```

```{r}
summary(wi$feemp_prct)
tapply(wi$feemp_prct, wi$year, summary)
```

```{r}
cor(wi$feemp_prct, wi$pov_prct)
```



```{r}
ggplot(data=wi, aes(x=pov_prct)) +
    facet_grid(.~ year) +
    geom_histogram(binwidth=0.01,color="black", aes(fill=factor(year))) +
    geom_density(alpha=.2, aes(fill=factor(year))) +
    theme_minimal() +
    xlab("Percent Poverty") +
    labs(title="County-Level Percent Poverty in Wisconsin Across Time", fill="Year") +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "none") +
    scale_fill_manual(values=c("chartreuse4", "deeppink4", "cornflowerblue","orange2","tomato3"))

breaks <- quantile(wi$logpov,seq(0,1,by=0.1))
ggplot(data=wi, aes(x=logpov)) +
    geom_histogram(aes(y =..density.., fill=factor(year)),color="black", breaks=breaks) +
    facet_grid(.~ year) +
    geom_density(alpha=.2, aes(fill=factor(year))) +
    theme_minimal() +
    xlab("(Log) Percent Poverty") +
    labs(title="County-Level (Log) Percent Poverty in Wisconsin Across Time", fill="Year") +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "none") +
    scale_fill_manual(values=c("chartreuse4", "deeppink4", "cornflowerblue","orange2","tomato3"))
    
```


```{r}
ggplot(wi) +
    geom_sf(aes(fill = pov_prct)) +
    scale_fill_viridis_c() +
    coord_sf(datum = NA) +
    facet_grid(. ~ year) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "County-Level Percent Poverty in Wisconsin Across Time", fill="%Poverty")


ggplot(wi) +
    geom_sf(aes(fill = logpov)) +
    scale_fill_viridis_c() +
    coord_sf(datum = NA) +
    facet_grid(. ~ year) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "County-Level (Log) Percent Poverty in Wisconsin Across Time", fill="(Log) %Poverty")
```

```{r}
ggplot(data=wi, aes(x=feemp_prct)) +
    facet_grid(.~ year) +
    geom_histogram(binwidth=0.01,color="black", aes(fill=factor(year))) +
    geom_density(alpha=.2, aes(fill=factor(year))) +
    theme_minimal() +
    xlab("Percent Female Employment") +
    labs(title="County-Level Percent Female Employment in Wisconsin Across Time", fill="Year") +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "none") +
    scale_fill_manual(values=c("chartreuse4", "deeppink4", "cornflowerblue","orange2","tomato3"))

breaks <- quantile(wi$logfeemp,seq(0,1,by=0.1))
ggplot(data=wi, aes(x=logfeemp)) +
    geom_histogram(aes(y =..density.., fill=factor(year)),color="black", breaks=breaks) +
    facet_grid(.~ year) +
    geom_density(alpha=.2, aes(fill=factor(year))) +
    theme_minimal() +
    xlab("(Log) Percent Female Employment") +
    labs(title="County-Level (Log) Percent Female Employment in Wisconsin Across Time", fill="Year") +
    theme(plot.title = element_text(hjust = 0.5),
          legend.position = "none") +
    scale_fill_manual(values=c("chartreuse4", "deeppink4", "cornflowerblue","orange2","tomato3"))
```

```{r}
ggplot(wi) +
    geom_sf(aes(fill = feemp_prct)) +
    scale_fill_viridis_c() +
    coord_sf(datum = NA) +
    facet_grid(. ~ year) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "County-Level Percent Female Employment in Wisconsin Across Time", fill="%Feemp")


ggplot(wi) +
    geom_sf(aes(fill = logfeemp)) +
    scale_fill_viridis_c() +
    coord_sf(datum = NA) +
    facet_grid(. ~ year) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "County-Level (Log) Percent Female Employment in Wisconsin Across Time", fill="(Log) %Feemp")
```


###Create Neighbors


We will first-order neigborhood structure (Queen's adjacency) with row-standardized spatial weights.

We have 5 years of data, however the spatial dependence between counties remains the same. Therefore, we will select unique counties to great neighbors and spatial weights


```{r}

wi_uniq <- wi %>%
    dplyr::filter(year==2018) %>%
    dplyr::select(GEOID, NAME)  %>%
    distinct() 
nrow(wi_uniq)
class(wi_uniq)
```


```{r}
row.names(wi_uniq) <- wi_uniq$NAME
head(row.names(wi_uniq))
wi_nb <- poly2nb(wi_uniq, row.names=row.names(wi_uniq))
str(head(wi_nb))

```

```{r}
listw_w <- nb2listw(wi_nb, style = "W")
class(listw_w)
str(head(listw_w$weights))
```

```{r, message=FALSE, warning=FALSE}
county_geoms <- st_geometry(wi_uniq)
cntrd <- st_centroid(county_geoms)
coords <- st_coordinates(cntrd)
head(coords)
```

```{r}
plot(listw_w, coords, col="blue")
```


###strm

```{r}
formula <-as.formula(logpov  ~ feemp_prct)
out <- strm(formula, id="NAME", data=as.data.frame(wi), listw = listw_w, time=5,wide=FALSE, returndf = TRUE)

summary(out$res)

summary(out$modframe)
```

```{r, warning=FALSE, message=FALSE}
out_df <- cbind.data.frame(resids = out$res$residuals,
                           stdresids = out$res$residuals/sd(out$res$residuals),
                           fit = out$res$fitted.values)

#QQ Plot
p1 <- ggplot(out_df, aes(sample = stdresids)) +
    geom_qq(size = 1) +
    stat_qq_line() +
    theme_minimal() +
    xlab("Theoretical Quantiles") +
    ylab("Standardized Residuals") +
    ggtitle("QQ Plot") + 
    theme(plot.title=element_text(hjust = 0.5))

#Residuals vs. Fitted Plot
p2 <- ggplot(out_df, aes(x=fit, y=stdresids)) +
    geom_point(size = 0.5) +
    geom_smooth(se=FALSE) +
    theme_minimal() +
    xlab("Fitted Values") +
    ylab("Standardized Residuals") +
    ggtitle("Residuals vs. Fitted Plot") + 
    theme(plot.title=element_text(hjust = 0.5))

p1 + p2

```

## Wide-Form Data


```{r}
wi_w <- as.data.frame(wi_raw) %>%
    dplyr::select(-moe) %>%
    spread(key = variable, value=estimate) %>%
    mutate(pov_prct = B17020_002/B17020_001,
           feemp_prct = B23022_026/B23022_001,
           year=id,
           logpov = log(pov_prct),
           logfeemp = log(pov_prct)) %>%
    dplyr::select(-id, -(B17020_001:B23022_026), - geometry) %>%
    relocate(year, .after=GEOID) %>%
    gather(variable, value, -(GEOID:NAME)) %>%
    unite(temp, variable, year) %>%
    spread(temp, value)

head(wi_w)
nrow(wi_w)
    
```



###Exploratory (Spatial) Data Analysis


```{r}
wi_2018geom <- wi %>%
    filter(year==2018) %>%
    dplyr::select(GEOID, geometry)
str(wi_2018geom)
#merge 2018 geometries back in
wi_w.sf <- merge(wi_2018geom, wi_w, by="GEOID")
    
nrow(wi_w.sf)
class(wi_w.sf)
```

```{r}
p18 <- ggplot(wi_w.sf) +
    geom_sf(aes(fill = logpov_2018)) +
    scale_fill_viridis_c(limits = c(-3.2, -1)) +
    coord_sf(datum = NA) +
    theme_minimal() +
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "2018", fill="(Log) %Feemp")

p17 <- ggplot(wi_w.sf) +
    geom_sf(aes(fill = logpov_2017)) +
    scale_fill_viridis_c(limits = c(-3.2, -1)) +
    coord_sf(datum = NA) +
    theme_minimal() +
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "2017", fill="(Log) %Feemp")

p16 <- ggplot(wi_w.sf) +
    geom_sf(aes(fill = logpov_2016)) +
    scale_fill_viridis_c(limits = c(-3.2, -1)) +
    coord_sf(datum = NA) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "2016", fill="(Log) %Feemp")

p15 <- ggplot(wi_w.sf) +
    geom_sf(aes(fill = logpov_2015)) +
    scale_fill_viridis_c(limits = c(-3.2, -1)) +
    coord_sf(datum = NA) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "2015", fill="(Log) %Feemp")

p14 <- ggplot(wi_w.sf) +
    geom_sf(aes(fill = logpov_2014)) +
    scale_fill_viridis_c(limits = c(-3.2, -1)) +
    coord_sf(datum = NA) +
    theme_minimal()+
    theme(plot.title=element_text(hjust = 0.5)) +
    labs(title = "2014", fill="(Log) %Feemp")

#patchwork the plots together
patch1 <- p14 + p15 + p16 + p17 + p18
patch1 + plot_annotation(title="County-Level (Log) Percent Poverty in Wisconsin Across Time") +
    plot_layout(guides = "collect")

```

###Create Neighbors

```{r}
row.names(wi_w.sf) <- wi_w.sf$NAME
head(row.names(wi_w.sf))
wi_nb_w <- poly2nb(wi_w.sf, row.names=row.names(wi_w.sf))
str(head(wi_nb_w))

```

```{r}
listw_w <- nb2listw(wi_nb_w, style = "W")
class(listw_w)
str(head(listw_w$weights))
```

```{r, message=FALSE, warning=FALSE}
county_geoms <- st_geometry(wi_w.sf)
cntrd <- st_centroid(county_geoms)
coords <- st_coordinates(cntrd)
head(coords)
```

```{r}
plot(listw_w, coords, col="blue")
```

###strm

```{r}


# formula <-as.formula(logpov  ~ feemp_prct)
# out <- strm(formula, id="NAME", data=as.data.frame(wi), listw = listw_w, time=5,wide=FALSE, returndf = TRUE)
#formula2 <- as.formula(LNP1000 ~ LNP0090 + POLD00 + POLD90)

##
formula2 <-as.formula(logpov_2018  ~ feemp_prct_2014 +feemp_prct_2015 + feemp_prct_2016 + 
                          feemp_prct_2017 + feemp_prct_2018 +  
                        logpov_2014 + logpov_2015 + logpov_2016 + logpov_2017)
out2 <- strm(formula2, id="NAME", data=as.data.frame(wi_w.sf), listw= listw_w, time=5, wide=TRUE)
summary(out2)

```

