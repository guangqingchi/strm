---
title: "An Introduction to spatemperr"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Intro to spatemperr}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.height = 5, fig.width = 8, message = TRUE, warning = FALSE)
library(tidyverse)
library(spatialreg)
```

`spatemperr` is an `R` package that fits spatio-temporal regression model based on Chi & Zhu *Spatial Regression Models for the Social Sciences* (2019). Based on Elhorst 2001, 2003, and 2010a, the approach here fits a spatial error model while incorporating a temporally lagged response variable, temporally lagged explanatory variables, and spatially lagged explanatory variables.

This package builds on the `errorsarlm()` function from the `spatialreg` package.

This package is still under development. Please report bugs or constructive tips to issues [here](https://github.com/mkamenet3/spatemperr/issues).


#Introduction


Fit a spatial error model but include a temporally lagged response variable, temporally lagged explanatory variable, and temporally and spatially lagged explanatory variables.

Spatial error model at time $t$:

$$Y_t = X_t \beta + u_t, u_t=\rho Wu_t + \varepsilon$$

Adding in a temporally lagged response variable and temporally lagged explanatory variable:

$$Y_t = X_t\beta_t + \beta_2Y_{t-1} + X_{t-1}\beta_3 + u_t, u_t=\rho Wu_t + \varepsilon$$


This becomes:

$$Y_t = Y_{t-1} \beta_2 + \rho W Y_t - \rho\beta_2 WY_{t-1} + X_t \beta_1 + X_{t-1}\beta_3 - W X_t \rho \beta_1 -WX_{t-1} \rho \beta_3 + \varepsilon$$


##Example 1: Produce in the United States


**TODO: Introduce example**


```{r}
#load data example
data("Produc", package = "Ecdat")
data("usaww")

#explore the data structures
str(Produc)
str(usaww)

#create list of spatial weights
usalw <- mat2listw(usaww)
str(usalw)

formula <- as.formula( gsp_log  ~ pcap_log + pc_log + emp_log + unemp)
out <- spatemperr(formula, id="state", data=Produc, listw= usalw, time=2,trans="log",year==1970 | year==1971)
summary(out)

```

```{r tester, eval=FALSE, echo=FALSE}
formula2 <- as.formula( gsp  ~ pcap + pc + emp + unemp)
out2 <- spatemperr(formula2, id="state", data=Produc, listw= usalw, time=2,trans=NULL,year==1970 | year==1971)

```


##Example 2: Minor Civil Divisions in Wisconsin

**TODO: Introduce example**

There are two years of data: 2000 and 2010.

```{r}
library(rgdal)
sptdmg <- readOGR("../data/sptdmg3/.", "sptdmg3")
class(sptdmg)
names(sptdmg)
```


First, fit a standard linear regression model with population growth from 2000 to 2010 as the response variable and population growth from 1990 to 2000, the old population in 2000, and the old population in 1990 as the explanatory variables.

```{r}
m1 <- lm(LNP1000 ~ LNP0090 + POLD00 + POLD90, data = sptdmg)
summary(m1)
```

Convert to long format (**TODO: FIX THIS**)

```{r}
#convert spatial polygons dataframe to sf to work with tidyverse
library(sf)
sptdmg_sf <- sf::st_as_sf(sptdmg)

sptdmg_long <- sptdmg_sf %>%
    dplyr::select(FIRST_NA_1, LNP1000, LNP0090, POLD00, POLD90) %>%
    tidyr::gather(year, POLD, POLD00:POLD90, factor_key=TRUE )

# 
# sptdmg_long1  <- sptdmg_sf %>%
#     dplyr::select(FIRST_NA_1, LNP1000, LNP0090, POLD00, POLD90) %>%
#     gather(year1, POLD,POLD00:POLD90) %>%
#     gather(year2, LNP, LNP1000:LNP0090) %>%
#     mutate(year = recode_factor(year2, `LNP1000`="year1",`LNP0090`= "year2")) %>%
#     arrange(FIRST_NA_1)

sptdmg_long1  <- sptdmg_sf %>%
    dplyr::select(FIRST_NA_1,  POLD00, POLD90) %>%
    gather(year1, POLD,POLD00:POLD90) %>%
    arrange(FIRST_NA_1)
sptdmg_long2  <- sptdmg_sf %>%
    dplyr::select(FIRST_NA_1, LNP1000, LNP0090) %>%
    gather(year2, LNP, LNP1000:LNP0090) %>%
    arrange(FIRST_NA_1)

sptdmg_long <- cbind.data.frame(sptdmg_long1, sptdmg_long2)   

m2 <- lm(LNP ~ POLD + year1, data=sptdmg_long)
summary(m2)
```



Create spatial weights matrix based on 4-nearest neighbors:

```{r}
nb.poly <- poly2nb(sptdmg, row.names=row.names(sptdmg))
listw <- nb2listw(nb.poly, style="W", zero.policy = TRUE)
coords <- coordinates(sptdmg)
plot(sptdmg, main="Wisconsin: Second-Order Neighbors");
plot(nb.poly, coords, col="blue", add=TRUE)

#knn4
col.knn <- knearneigh(coords, k=4)
nbknn <- knn2nb(col.knn)
listwk <- nb2listw(nbknn, style="W", zero.policy = TRUE)
plot(sptdmg, main="Wisconsin: 4 Nearest-Neighbors"); plot(nbknn, coords,col="forestgreen", add=TRUE)
```

Perform spatio-temporal regression model:

```{r}
formula <- as.formula(LNP ~ POLD)
res <- spatemperr(formula2, id="state", data=Produc, listw= usalw, time=2,trans=NULL,year==1970 | year==1971)

```






